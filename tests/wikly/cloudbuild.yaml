steps:
  # ---------------------------------------------
  # (0) Copy source/ to GCS before calling functions
  # ---------------------------------------------
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: bash
    args:
      - -c
      - |
        echo "üìÅ –§–∞–π–ª—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ tests/wikly/:"
        ls -R tests/wikly/
        
        echo "‚¨ÜÔ∏è –ö–æ–ø–∏—Ä—É–µ–º –≤ GCS: gs://qa-test-roidev/tests-wikly/"
        gsutil -m cp -r tests/wikly/* gs://qa-test-roidev/tests-wikly/
        
        echo "‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞–∫–µ—Ç–∞:"
        gsutil ls -R gs://qa-test-roidev/tests-wikly/source/

  # ---------------------------------------------
  # (1) Your original function-invocation step
  # ---------------------------------------------
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: 'python3'
    args:
      - "-c"
      - |
        import subprocess
        import base64
        import json
        import sys

        REGIONS = ["us-central1"]
        FUNCTION = "my-function"
        BUILD_ID = "${BUILD_ID}"

        def execute_command(command):
            try:
                # Run command
                result = subprocess.run(command, check=True, capture_output=True, text=True)
                response_json = result.stdout.strip()
                execution_name = response_json.get('status', {}).get('latestCreatedExecution', {}).get('name')

                if not execution_name:
                    # –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ª—É—á–∏—Ç—å—Å—è, –µ—Å–ª–∏ Job –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å–ª–∏—à–∫–æ–º –±—ã—Å—Ç—Ä–æ –∏–ª–∏ —É–ø–∞–ª –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
                    raise Exception("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å Execution ID –∏–∑ –æ—Ç–≤–µ—Ç–∞ Cloud Run. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏.")
                
                print("–û—Ç–≤–µ—Ç Cloud Run Job (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∞):")
                print(result.stdout.strip())
                print(f"Execution ID: {execution_name}")

                # 3. –ß–∏—Ç–∞–µ–º –ª–æ–≥–∏ –¥–ª—è —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
                print("\n--- –õ–û–ì–ò –ö–û–ù–¢–ï–ô–ù–ï–†–ê (–∏–∑ Cloud Logging) ---")
                
                # –§–∏–ª—å—Ç—Ä –¥–ª—è gcloud logging read
                log_filter = (
                    f'resource.type="cloud_run_job" '
                    f'resource.labels.job_name="{function_name}" '
                    f'resource.labels.location="{region}" '
                    f'resource.labels.execution_name="{execution_name}"'
                )

                # –ß–∏—Ç–∞–µ–º –ª–æ–≥–∏ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –≤ 100 –∑–∞–ø–∏—Å–µ–π
                log_read_command = [
                    'gcloud', 'logging', 'read', log_filter,
                    '--project', PROJECT_ID,
                    '--limit', '100',
                    '--format=json' 
                ]
                
                log_result = subprocess.run(log_read_command, check=False, capture_output=True, text=True)
                
                # –í—ã–≤–æ–¥–∏–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –ª–æ–≥–∏
                if log_result.stdout:
                    logs = json.loads(log_result.stdout)
                    if logs:
                        print(f"–ù–∞–π–¥–µ–Ω–æ {len(logs)} –∑–∞–ø–∏—Å–µ–π –ª–æ–≥–æ–≤.")
                        for entry in logs:
                            # –í—ã–≤–æ–¥–∏–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –∏–ª–∏ JSON-—Ç–µ–ª–æ
                            payload = entry.get('textPayload') or entry.get('jsonPayload')
                            print(f"[{entry.get('timestamp')}] {payload}")
                    else:
                        print("–õ–æ–≥–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Cloud Logging –¥–ª—è —ç—Ç–æ–≥–æ Execution ID.")
                else:
                    print("–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –ª–æ–≥–æ–≤ Gcloud (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞).")
                
                return "SUCCESS" # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–∏–∑–Ω–∞–∫ —É—Å–ø–µ—Ö–∞

            except subprocess.CalledProcessError as e:
                # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ gcloud (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω—ã–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∏–ª–∏ Job –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
                print("\n‚ùå Critical error")
                print(f"Command: {' '.join(e.cmd)}")
                print(f"Stderr: {e.stderr.strip()[:500]}")
                sys.exit(1)

            except Exception as e:
                # –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –∏–ª–∏ –¥—Ä—É–≥–∞—è –æ—à–∏–±–∫–∞
                print(f"\n‚ùå Execution/Parsing Error: {e}")
                sys.exit(1)

        for region in REGIONS:
            print(f"\n--- –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–∑–æ–≤ Cloud Run Job {FUNCTION} –≤ —Ä–µ–≥–∏–æ–Ω–µ {region} ---")

            payload = str(json.dumps({
                'source': 'gs://qa-test-roidev/tests-wikly/source/',
                'region': region,
                'build_id': BUILD_ID
            }))
            b64_str = base64.b64encode(payload.encode('utf-8')).decode('utf-8')
            payload_value = f"INPUT_PAYLOAD='{b64_str}'"

            job_execute_command = [
                'gcloud', 'run', 'jobs', 'execute', FUNCTION,
                f'--region={region}',
                f'--update-env-vars={payload_value}',
                '--wait' # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Job
            ]

            print(f"–í—ã–∑—ã–≤–∞–µ–º Job. –ö–æ–º–∞–Ω–¥–∞: {' '.join(job_execute_command)}")

            response = execute_command(job_execute_command)

            
            # Cloud Run execute –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∞, –∞ –Ω–µ –≤—ã–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞.
            print("–û—Ç–≤–µ—Ç Cloud Run Job (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∞):")
            print(response)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ Job (–≤–∫–ª—é—á–∞—è –∏–º—è Execution ID)
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º Execution ID –∏–∑ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏
                # (–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ—Ç —à–∞–≥ –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ logs.googleapis.com/run_job)
                execution_name = response.split('name: ')[-1].split('\n')[0].strip()
                print(f"Execution ID: {execution_name}")
            except:
                pass

            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω–æ {FUNCTION} –≤ {region}. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥–∞—Ö Cloud Logging.")

options:
  logging: CLOUD_LOGGING_ONLY
