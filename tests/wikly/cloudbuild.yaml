steps:
  # ---------------------------------------------
  # (0) Copy source/ to GCS before calling functions
  # ---------------------------------------------
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk:latest"
    entrypoint: bash
    args:
      - -c
      - |
        echo "üìÅ –§–∞–π–ª—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ source/:"
        ls -R source/
        
        echo "‚¨ÜÔ∏è –ö–æ–ø–∏—Ä—É–µ–º –≤ GCS: gs://qa-test-roidev/tests-wikly/source/"
        gsutil -m cp -r source/* gs://qa-test-roidev/tests-wikly/source/
        
        echo "‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞–∫–µ—Ç–∞:"
        gsutil ls -R gs://qa-test-roidev/tests-wikly/source/

  # ---------------------------------------------
  # (1) Your original function-invocation step (–ù–ï –¢–†–û–ù–£–¢)
  # ---------------------------------------------
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk:latest"
    entrypoint: 'python3'
    args:
      - "-c"
      - |
        import subprocess
        import json
        import sys

        REGIONS = ["us-central1"]
        FUNCTIONS = ["my_function"]
        BUILD_ID = "${BUILD_ID}"

        def execute_command(command_parts, error_msg):
            try:
                result = subprocess.run(command_parts, check=True, capture_output=True, text=True)
                return result.stdout.strip()
            except subprocess.CalledProcessError as e:
                print(f"\n‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {error_msg}")
                print(f"–ö–æ–º–∞–Ω–¥–∞: {' '.join(command_parts)}")
                print(f"Stderr: {e.stderr.strip()[:500]}")
                sys.exit(1)

        for region in REGIONS:
            for func in FUNCTIONS:
                print(f"\n--- –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–∑–æ–≤ {func} –≤ —Ä–µ–≥–∏–æ–Ω–µ {region} ---")

                # –ü–æ–ª—É—á–∞–µ–º URL —Ñ—É–Ω–∫—Ü–∏–∏
                URL = execute_command([
                    'gcloud', 'functions', 'describe', func,
                    f'--region={region}',
                    '--gen2',
                    '--format=value(serviceConfig.uri)'
                ], f"–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å URL –¥–ª—è {func}")
                print(f"URL: {URL}")

                # –ü–æ–ª—É—á–∞–µ–º IAM —Ç–æ–∫–µ–Ω
                TOKEN = execute_command([
                    'gcloud', 'auth', 'print-identity-token',
                    '--audiences', URL
                ], "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å IAM —Ç–æ–∫–µ–Ω")

                # –§–æ—Ä–º–∏—Ä—É–µ–º payload
                PAYLOAD = json.dumps({
                    "source": "gs://qa-test-roidev/tests-wikly/source/",
                    "region": region,
                    "build_id": BUILD_ID
                })

                # –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏ –ø–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
                curl_command = [
                    'curl', '-s', '-X', 'POST', URL,
                    '-H', f'Authorization: Bearer {TOKEN}',
                    '-H', 'Content-Type: application/json',
                    '-d', PAYLOAD
                ]
                response = execute_command(curl_command, f"–í—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ {func} –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –æ—à–∏–±–∫–æ–π")

                # –ü–µ—á–∞—Ç–∞–µ–º –æ—Ç–≤–µ—Ç –≤ Cloud Build –ª–æ–≥–∏
                try:
                    parsed = json.loads(response)
                    print("–û—Ç–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ (parsed JSON):")
                    print(json.dumps(parsed, indent=2))
                except json.JSONDecodeError:
                    print("–û—Ç–≤–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ (raw):")
                    print(response)

                print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω–æ {func} –≤ {region}")

options:
  logging: CLOUD_LOGGING_ONLY
