steps:
  # ---------------------------------------------
  # (0) Copy source/ to GCS before calling functions
  # ---------------------------------------------
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: bash
    args:
      - -c
      - |
        echo "üìÅ –§–∞–π–ª—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑ tests/wikly/:"
        ls -R tests/wikly/
        
        echo "‚¨ÜÔ∏è –ö–æ–ø–∏—Ä—É–µ–º –≤ GCS: gs://qa-test-roidev/tests-wikly/"
        gsutil -m cp -r tests/wikly/* gs://qa-test-roidev/tests-wikly/
        
        echo "‚úÖ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±–∞–∫–µ—Ç–∞:"
        gsutil ls -R gs://qa-test-roidev/tests-wikly/source/

  # ---------------------------------------------
  # (1) Your original function-invocation step
  # ---------------------------------------------
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: 'python3'
    args:
      - "-c"
      - |
        import subprocess
        import json
        import sys

        REGIONS = ["us-central1"]
        FUNCTION = "my-function"
        BUILD_ID = "${BUILD_ID}"

        def execute_command(command):
            try:
                # Run command
                result = subprocess.run(command, check=True, capture_output=True, text=True)
                return result.stdout.strip()
            except subprocess.CalledProcessError as e:
                # Error handling
                print("\n‚ùå Critical error")
                print(f"Command: {' '.join(command)}")
                print(f"Stderr: {e.stderr.strip()[:500]}")
                sys.exit(1)

        for region in REGIONS:
            print(f"\n--- –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–∑–æ–≤ Cloud Run Job {FUNCTION} –≤ —Ä–µ–≥–∏–æ–Ω–µ {region} ---")

            payload = json.dumps({
                'source': 'gs://qa-test-roidev/tests-wikly/source/',
                'region': region,
                'build_id': BUILD_ID
            })
            payload_value = f'INPUT_PAYLOAD={json_payload}'

            job_execute_command = [
                'gcloud', 'run', 'jobs', 'execute', FUNCTION,
                f'--region={region}',
                f'--update-env-vars={payload_value}',
                '--wait' # –û–∂–∏–¥–∞–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è Job
            ]

            print(f"–í—ã–∑—ã–≤–∞–µ–º Job. –ö–æ–º–∞–Ω–¥–∞: {' '.join(job_execute_command)}")

            response = execute_command(job_execute_command)
            
            # Cloud Run execute –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∞, –∞ –Ω–µ –≤—ã–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞.
            print("–û—Ç–≤–µ—Ç Cloud Run Job (–º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∑–∞–ø—É—Å–∫–∞):")
            print(response)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏ Job (–≤–∫–ª—é—á–∞—è –∏–º—è Execution ID)
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º Execution ID –∏–∑ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –ª–æ–≥–∏
                # (–í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ —ç—Ç–æ—Ç —à–∞–≥ –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ logs.googleapis.com/run_job)
                execution_name = response.split('name: ')[-1].split('\n')[0].strip()
                print(f"Execution ID: {execution_name}")
            except:
                pass

            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—ã–∑–≤–∞–Ω–æ {FUNCTION} –≤ {region}. –†–µ–∑—É–ª—å—Ç–∞—Ç –≤ –ª–æ–≥–∞—Ö Cloud Logging.")

options:
  logging: CLOUD_LOGGING_ONLY
